"use strict";(self.webpackChunk_jupyter_ai_core=self.webpackChunk_jupyter_ai_core||[]).push([[563],{27563:(e,t,n)=>{n.r(t),n.d(t,{CommandIDs:()=>ee,NotebookTasks:()=>X,default:()=>ae});var o=n(41123),l=n(51473),a=n(28142),r=n(48820);const i="api/ai";async function c(e="",t={}){const n=r.ServerConnection.makeSettings(),o=a.URLExt.join(n.baseUrl,i,e);let l;try{l=await r.ServerConnection.makeRequest(o,t,n)}catch(e){throw new r.ServerConnection.NetworkError(e)}let c=await l.text();if(c.length>0)try{c=JSON.parse(c)}catch(e){console.log("Not a JSON response body.",l)}if(!l.ok)throw new r.ServerConnection.ResponseError(l,c.message||c);return c}var s;!function(e){e.sendPrompt=async function(e){let t;try{t=await c("prompt",{method:"POST",body:JSON.stringify(e)})}catch(e){return Promise.reject(e)}return t},e.sendChat=async function(e){let t;try{t=await c("chat",{method:"POST",body:JSON.stringify(e)})}catch(e){return Promise.reject(e)}return t},e.listTasks=async function(){return c("tasks")},e.describeTask=async function(e){return c(`tasks/${e}`)}}(s||(s={}));var d=n(56271),u=n.n(d),m=n(13191);function p(e){const[t,n]=(0,d.useState)(!1),[o,l]=(0,d.useState)(!1),{label:a,style:r,helperText:i,InputProps:c}=e,s=(0,d.useRef)(null);return(0,d.useEffect)((()=>{n(!1);const e=s.current;(null==e?void 0:e.offsetWidth)&&(null==e?void 0:e.scrollWidth)&&l(e.offsetWidth<e.scrollWidth)}),[e.text]),u().createElement("div",{id:e.id,style:{display:"flex",flexDirection:"column",...r}},u().createElement("span",{className:"jp-ai-ExpandableTextField-label"},a),u().createElement("div",{style:{display:"flex",flexDirection:"column"}},u().createElement("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"}},null==c?void 0:c.startAdornment,u().createElement("span",{className:"jp-ai-ExpandableTextField-value "+(t?"jp-ai-ExpandableTextField-value-expanded":"jp-ai-ExpandableTextField-value-collapsed"),ref:s},e.text?e.text:!(null==c?void 0:c.startAdornment)&&"—")),o&&u().createElement("div",{style:{textDecoration:"underline"},onClick:()=>n(!t),className:"jp-ai-ExpandableTextField-value"},t?"Show Less":"Show More"),u().createElement("span",{className:"jp-ai-ExpandableTextField-label",style:{maxWidth:"fit-content"}},i)))}async function g(e,t){return e.commands.execute(`ai:insert-${t.response.insertion_mode}`,t),!0}var f=n(71893),b=n(14859);function h(e){return getComputedStyle(document.body).getPropertyValue(e).trim()}function v(e){const[t,n]=(0,d.useState)((0,f.Z)());return(0,d.useEffect)((()=>{!async function(){n(await async function(){await async function(){for(;!document.body.hasAttribute("data-jp-theme-light");)await new Promise((e=>setTimeout(e,100)))}();const e=document.body.getAttribute("data-jp-theme-light");return(0,f.Z)({spacing:4,components:{MuiButton:{defaultProps:{size:"small"}},MuiFilledInput:{defaultProps:{margin:"dense"}},MuiFormControl:{defaultProps:{margin:"dense",size:"small"}},MuiFormHelperText:{defaultProps:{margin:"dense"}},MuiIconButton:{defaultProps:{size:"small"}},MuiInputBase:{defaultProps:{margin:"dense",size:"small"}},MuiInputLabel:{defaultProps:{margin:"dense"}},MuiListItem:{defaultProps:{dense:!0}},MuiOutlinedInput:{defaultProps:{margin:"dense"}},MuiFab:{defaultProps:{size:"small"}},MuiTable:{defaultProps:{size:"small"}},MuiTextField:{defaultProps:{margin:"dense",size:"small"}},MuiToolbar:{defaultProps:{variant:"dense"}}},palette:{background:{paper:h("--jp-layout-color1"),default:h("--jp-layout-color1")},mode:"true"===e?"light":"dark",primary:{main:h("--jp-brand-color1"),light:h("--jp-brand-color2"),dark:h("--jp-brand-color0")},error:{main:h("--jp-error-color1"),light:h("--jp-error-color2"),dark:h("--jp-error-color0")},warning:{main:h("--jp-warn-color1"),light:h("--jp-warn-color2"),dark:h("--jp-warn-color0")},success:{main:h("--jp-success-color1"),light:h("--jp-success-color2"),dark:h("--jp-success-color0")},text:{primary:h("--jp-ui-font-color1"),secondary:h("--jp-ui-font-color2"),disabled:h("--jp-ui-font-color3")}},shape:{borderRadius:2},typography:{fontFamily:h("--jp-ui-font-family"),fontSize:12,htmlFontSize:16,button:{textTransform:"capitalize"}}})}())}()}),[]),u().createElement(b.Z,{theme:t},e.children)}const x={above:"AI output will be inserted above the selected text",replace:"AI output will replace the selected text",below:"AI output will be inserted below the selected text","above-in-cells":"AI output will be inserted above in new notebook cells","below-in-cells":"AI output will be inserted below in new notebook cells"};function y(e){const[t,n]=(0,d.useState)([]),[o,l]=(0,d.useState)(""),[a,r]=(0,d.useState)(),[i,c]=(0,d.useState)(""),[f,b]=(0,d.useState)(!1);(0,d.useEffect)((()=>{!async function(){const e=await s.listTasks();if(n(e.tasks),!e.tasks.length)return void console.error("No tasks returned via the backend");const t=e.tasks[0].id;l(t);const o=await s.describeTask(t);r(o)}()}),[]),(0,d.useEffect)((()=>{var e;(null===(e=null==a?void 0:a.engines)||void 0===e?void 0:e.length)&&c(a.engines[0].id)}),[a]);const h=(null==a?void 0:a.insertion_mode)&&a.insertion_mode in x?x[a.insertion_mode]:"";return u().createElement(v,null,u().createElement(m.Box,{padding:1,width:"40em"},u().createElement(m.Stack,{spacing:4},u().createElement(m.FormControl,{fullWidth:!0},u().createElement(m.InputLabel,{id:"task-select-label"},"Task"),u().createElement(m.Select,{value:o,onChange:async e=>{l(e.target.value);const t=await s.describeTask(e.target.value);r(t)},label:"Task",labelId:"task-select-label",MenuProps:{style:{zIndex:2e4}},autoFocus:!0},t.map((e=>u().createElement(m.MenuItem,{key:e.id,value:e.id},e.name))))),u().createElement(m.Box,{pt:4,width:"40em"},u().createElement(m.Stack,{spacing:4},u().createElement(m.FormControl,{fullWidth:!0},u().createElement(m.InputLabel,{id:"engine-select-label"},"Model engine"),u().createElement(m.Select,{value:i,onChange:async e=>{c(e.target.value)},label:"Model engine",labelId:"engine-select-label",MenuProps:{style:{zIndex:2e4}},autoFocus:!0},null==a?void 0:a.engines.map((e=>u().createElement(m.MenuItem,{key:e.id,value:e.id},e.name))))),u().createElement(p,{label:"Prompt template",text:null==a?void 0:a.prompt_template}),h&&u().createElement(p,{label:"Task description",text:h}))),u().createElement(m.Stack,{direction:"row",justifyContent:"flex-end",spacing:1},u().createElement(m.Button,{variant:"outlined",onClick:e.closeDialog},"Cancel"),u().createElement(m.Button,{variant:"contained",onClick:async()=>{b(!0);try{const t={task_id:o,engine_id:i,prompt_variables:{body:e.selectedText}},n=await s.sendPrompt(t);return g(e.app,{widget:e.editorWidget,request:t,response:n}),e.closeDialog(),!0}catch(e){return alert("**Failed** with error:\n```\n"+e.message+"\n```"),b(!1),!1}},disabled:!!f||""===o},f?"Submitting…":"Submit")))))}var w=n(73033);class C extends w.Dialog{constructor(e){const t={...e.props,closeDialog:()=>{this.dispose()}};super({...e.body,body:w.ReactWidget.create(u().createElement(e.body,Object.assign({},t))),buttons:[]})}async open(){try{await super.launch()}catch(e){if(void 0!==e)throw e}}}function k(e){const t=E(e);if(!t)return"";const n=t.getSelection(),o=t.getOffsetAt(n.start),l=t.getOffsetAt(n.end);return t.model.sharedModel.getSource().substring(o,l)}function E(e){var t;let n;return e instanceof l.FileEditor?n=e.editor:e instanceof o.Notebook&&(n=null===(t=e.activeCell)||void 0===t?void 0:t.editor),n}function S(e,t){var n;const o=null===(n=e.model)||void 0===n?void 0:n.sharedModel.cells.findIndex((e=>e.getId()===t));return void 0===o?-1:o}function I(e,t){return async function(){var n;const l=null===(n=e.currentWidget)||void 0===n?void 0:n.content;if(!l)return console.error("Notebook is undefined."),!1;const a=l.activeCell;if(null===a)return console.error("Current cell is null."),!1;"raw"===a.model.type&&console.error("Current cell has invalid type `raw`.");const r="markdown"===a.model.type?X.GenerateCode:X.ExplainCode,i=a.model.sharedModel.getSource();console.log(`Calling ${r} command on source ${i}`);const c=function(e,t){const n=e.model,l=e.activeCellIndex;if(null===n)return"";"above-in-cells"===t?o.NotebookActions.insertAbove(e):o.NotebookActions.insertBelow(e);const a=e.activeCellIndex;o.NotebookActions.changeCellType(e,"markdown");const r=n.cells.get(a);return null==r||r.sharedModel.setSource("Analyzing your code …"),o.NotebookActions.runAndAdvance(e),e.activeCellIndex=l,r.id}(l,r===X.ExplainCode?"above-in-cells":"below-in-cells"),d={task_id:r,engine_id:"chatgpt",prompt_variables:{body:i}};let u;try{u=await s.sendPrompt(d)}catch(e){return function(e,t,n){var l,a;const r=S(e,t);-1!==r&&(e.activeCellIndex=r,o.NotebookActions.changeCellType(e,"markdown"),null===(a=null===(l=e.model)||void 0===l?void 0:l.cells.get(r))||void 0===a||a.sharedModel.setSource(n),o.NotebookActions.run(e))}(l,c,"**Failed** with error:\n```\n"+e.message+"\n```"),!1}finally{!function(e,t){var n;const o=S(e,t);-1!==o&&(null===(n=e.model)||void 0===n||n.sharedModel.deleteCell(o))}(l,c)}return g(t,{widget:l,request:d,response:u}),!0}}function A(e){return function(t){var n,o,l;const{widget:a,request:r,response:i}=t,c=E(a);if(!c)return!1;switch(e){case"above":null===(n=c.replaceSelection)||void 0===n||n.call(c,`${i.output}\n\n${r.prompt_variables.body}`);break;case"below":null===(o=c.replaceSelection)||void 0===o||o.call(c,`${r.prompt_variables.body}${i.output}`);break;case"replace":null===(l=c.replaceSelection)||void 0===l||l.call(c,i.output)}return!0}}function N(e){return function(t){var n;const{widget:l,response:a}=t;if(!(l instanceof o.Notebook))return console.error('Editor widget is not of type "Notebook".'),!1;const r=function(e){const t=[],n=e.split(/(```[a-z]*\n[\s\S]*?```)/g).map((e=>e.trim()));for(const e of n){let n="",o="markdown";e.startsWith("```")?(o="code",n=e.replace(/^```[a-z]*\n/,"").replace(/```$/,"").trim()):n=e.trim(),n.length>0&&t.push({cellType:o,source:n})}return t}(a.output);if(r.length<1)return console.error("No output cells."),!1;"above-in-cells"===e?o.NotebookActions.insertAbove(l):o.NotebookActions.insertBelow(l);for(let e=0;e<r.length;e++){const t=r[e];e>0&&o.NotebookActions.insertBelow(l),null===(n=l.activeCell)||void 0===n||n.model.sharedModel.setSource(t.source),o.NotebookActions.changeCellType(l,t.cellType),"markdown"===t.cellType&&o.NotebookActions.run(l)}return!0}}function j(e,t){return async function(){var n;const o=null===(n=e.currentWidget)||void 0===n?void 0:n.content;if(!o)return!1;const l=k(o);return new C({body:y,props:{selectedText:l,app:t,editorWidget:o}}).open(),!0}}const T=new(n(22502).LabIcon)({name:"jupyter-ai::psychology",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" class="css-10cscxr" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="PsychologyIcon">\n    <path d="M13 8.57c-.79 0-1.43.64-1.43 1.43s.64 1.43 1.43 1.43 1.43-.64 1.43-1.43-.64-1.43-1.43-1.43z"></path><path d="M13 3C9.25 3 6.2 5.94 6.02 9.64L4.1 12.2c-.25.33-.01.8.4.8H6v3c0 1.1.9 2 2 2h1v3h7v-4.68c2.36-1.12 4-3.53 4-6.32 0-3.87-3.13-7-7-7zm3 7c0 .13-.01.26-.02.39l.83.66c.08.06.1.16.05.25l-.8 1.39c-.05.09-.16.12-.24.09l-.99-.4c-.21.16-.43.29-.67.39L14 13.83c-.01.1-.1.17-.2.17h-1.6c-.1 0-.18-.07-.2-.17l-.15-1.06c-.25-.1-.47-.23-.68-.39l-.99.4c-.09.03-.2 0-.25-.09l-.8-1.39c-.05-.08-.03-.19.05-.25l.84-.66c-.01-.13-.02-.26-.02-.39s.02-.27.04-.39l-.85-.66c-.08-.06-.1-.16-.05-.26l.8-1.38c.05-.09.15-.12.24-.09l1 .4c.2-.15.43-.29.67-.39L12 6.17c.02-.1.1-.17.2-.17h1.6c.1 0 .18.07.2.17l.15 1.06c.24.1.46.23.67.39l1-.4c.09-.03.2 0 .24.09l.8 1.38c.05.09.03.2-.05.26l-.85.66c.03.12.04.25.04.39z">\n    </path>\n</svg>'});var _,M=n(18377),P=n(45275),W=n(48942),B=n.n(W),F=n(96707),z=n.n(F),O=n(40532),D=n.n(O),L=(n(38662),n(72647)),R=n(93528);function $({className:e,children:t,...n}){return u().createElement("code",Object.assign({},n,{className:e}),t)}!function(e){e[e.None=0]="None",e[e.Copying=1]="Copying",e[e.Copied=2]="Copied"}(_||(_={}));const G={[_.None]:"Copy to clipboard",[_.Copying]:"Copying...",[_.Copied]:"Copied!"};function Z({language:e,children:t,...n}){const o=(0,d.useMemo)((()=>String(t).replace(/\n$/,"")),[t]),[l,a]=(0,d.useState)(_.None);return u().createElement(m.Box,{sx:{display:"flex",flexDirection:"column"}},u().createElement(L.Prism,Object.assign({},n,{children:o,style:R.Z,language:e,PreTag:"div"})),u().createElement(m.Button,{onClick:async()=>{a(_.Copying);try{await navigator.clipboard.writeText(o)}catch(e){return console.error(e),void a(_.None)}a(_.Copied),setTimeout((()=>a(_.None)),1e3)},disabled:l!==_.None,sx:{alignSelf:"flex-end"}},G[l]))}function J({inline:e,className:t,...n}){const o=/language-(\w+)/.exec(t||"");return e?u().createElement($,Object.assign({},n)):u().createElement(Z,Object.assign({},n,{language:o?o[1]:void 0}))}function q(e){const t=(0,m.useTheme)(),n=t.spacing(2);return u().createElement(m.Box,{sx:{display:"flex"," > :not(:last-child)":{marginRight:2}}},function(e){const t={height:"2em",width:"2em"};switch(e){case"self":return u().createElement(m.Avatar,{src:"",sx:{...t}});case"ai":return u().createElement(m.Avatar,{sx:{...t}},u().createElement(P.Z,null));default:return u().createElement(m.Avatar,{src:"?",sx:{...t}})}}(e.sender),u().createElement(m.Box,{sx:{flexGrow:1,minWidth:0}},e.messages.map(((o,l)=>u().createElement(m.Box,{key:l},u().createElement(m.Box,{sx:{display:"inline-block",padding:t.spacing(1,2),borderRadius:n,marginBottom:1,wordBreak:"break-word",textAlign:"left",maxWidth:"100%",boxSizing:"border-box",..."self"===e.sender?{backgroundColor:t.palette.primary.main,color:t.palette.common.white}:{backgroundColor:t.palette.grey[100]}}},u().createElement(B(),{components:{code:J},remarkPlugins:[z()],rehypePlugins:[D()]},o)))))))}var H=n(26307);function U(e){return u().createElement(m.Box,{sx:e.sx},u().createElement(m.Box,{sx:{display:"flex"}},u().createElement(m.Input,{value:e.value,onChange:t=>e.onChange(t.target.value),multiline:!0,sx:{flexGrow:1}}),u().createElement(m.IconButton,{size:"large",color:"primary",onClick:e.onSend,disabled:e.loading||!e.value.trim().length},u().createElement(H.Z,null))),e.hasSelection&&u().createElement(m.FormGroup,{sx:{display:"flex",flexDirection:"row"}},u().createElement(m.FormControlLabel,{control:u().createElement(m.Checkbox,{checked:e.includeSelection,onChange:e.toggleIncludeSelection}),label:"Include selection"}),u().createElement(m.FormControlLabel,{control:u().createElement(m.Checkbox,{checked:e.replaceSelection,onChange:e.toggleReplaceSelection}),label:"Replace selection"})))}const V=u().createContext(["",()=>{}]);function Y({selectionWatcher:e,children:t}){const[n,o]=(0,d.useState)("");(0,d.useEffect)((()=>{e.selectionChanged.connect(((e,t)=>{o(t)}))}),[]);const l=(0,d.useCallback)((t=>{e.replaceSelection(t)}),[e]);return u().createElement(V.Provider,{value:[n,l]},t)}function K(){const[e,t]=(0,d.useState)([]),[n,o]=(0,d.useState)(!1),[l,a]=(0,d.useState)(!0),[r,i]=(0,d.useState)(!1),[c,m]=(0,d.useState)(""),[p,g]=(0,d.useContext)(V);return u().createElement(M.Z,{sx:{width:"100%",height:"100%",boxSizing:"border-box",background:"white",display:"flex",flexDirection:"column"}},u().createElement(M.Z,{sx:{flexGrow:1,padding:2,overflowY:"scroll","> :not(:last-child)":{marginBottom:1}}},e.map(((e,t)=>u().createElement(q,{key:t,sender:e.sender,messages:e.messages})))),u().createElement(U,{loading:n,value:c,onChange:m,onSend:async()=>{o(!0),m(""),console.log({includeSelection:l,replaceSelection:r});const e=[c];let n;l&&p&&e.push("```\n"+p+"\n```"),t((t=>[...t,{sender:"self",messages:e}]));const a=c+(p?"\n--\n"+p:"");try{n=await s.sendChat({prompt:a})}finally{o(!1)}r&&g(n.output),t((e=>[...e,{sender:"ai",messages:[n.output]}]))},hasSelection:!!p,includeSelection:l,toggleIncludeSelection:()=>a((e=>!e)),replaceSelection:r,toggleReplaceSelection:()=>i((e=>!e)),sx:{padding:2}}))}function Q(e){return u().createElement(v,null,u().createElement(Y,{selectionWatcher:e.selectionWatcher},u().createElement(K,null)))}var X,ee,te=n(45687),ne=n(80819),oe=n(71840);class le{constructor(e){if(this._mainAreaWidget=null,this._selection="",this._selectionChanged=new oe.Signal(this),!(e instanceof te.LabShell))throw"Shell is not an instance of LabShell. Jupyter AI does not currently support custom shells.";e.currentChanged.connect(((e,t)=>{this._mainAreaWidget=t.newValue})),setInterval(this._poll.bind(this),200)}get selectionChanged(){return this._selectionChanged}replaceSelection(e){var t;if(!(this._mainAreaWidget instanceof ne.DocumentWidget))return;const n=E(this._mainAreaWidget.content);null===(t=null==n?void 0:n.replaceSelection)||void 0===t||t.call(n,e)}_poll(){if(!(this._mainAreaWidget instanceof ne.DocumentWidget))return;const e=this._selection,t=k(this._mainAreaWidget.content);e!==t&&(this._selection=t,this._selectionChanged.emit(t))}}!function(e){e.GenerateCode="generate-code-in-cells-below",e.ExplainCode="explain-code-in-cells-above"}(X||(X={})),function(e){e.explainCodeCell="ai:explain-code-cell",e.codifyMdCell="ai:codify-md-cell",e.explainOrCodifyCell="ai:explain-or-codify-cell",e.generateFromNotebookSelection="ai:generate-from-notebook-selection",e.generateFromEditorSelection="ai:generate-from-editor-selection",e.insertAbove="ai:insert-above",e.insertBelow="ai:insert-below",e.insertReplace="ai:insert-replace",e.insertAboveInCells="ai:insert-above-in-cells",e.insertBelowInCells="ai:insert-below-in-cells"}(ee||(ee={}));const ae={id:"jupyter_ai:plugin",autoStart:!0,requires:[o.INotebookTracker,l.IEditorTracker],activate:(e,t,n)=>{const{commands:o,shell:l}=e;o.addCommand(ee.generateFromNotebookSelection,{execute:j(t,e),label:"Generate output from selection with AI...",icon:T,isEnabled:()=>{var e;const n=null===(e=null==t?void 0:t.currentWidget)||void 0===e?void 0:e.content;return!(!n||!k(n))}}),o.addCommand(ee.generateFromEditorSelection,{execute:j(n,e),label:"Generate output from selection with AI...",icon:T,isEnabled:()=>{var e;const t=null===(e=null==n?void 0:n.currentWidget)||void 0===e?void 0:e.content;return!(!t||!k(t))}});const a=new le(l);l.add(function(e){const t=w.ReactWidget.create(u().createElement(Q,{selectionWatcher:e}));return t.id="jupyter-ai::chat",t.title.icon=T,t.title.caption="Jupyter AI Chat",t}(a),"right"),o.addCommand(ee.insertAbove,{execute:A("above")}),o.addCommand(ee.insertBelow,{execute:A("below")}),o.addCommand(ee.insertReplace,{execute:A("replace")}),o.addCommand(ee.insertAboveInCells,{execute:N("above-in-cells")}),o.addCommand(ee.insertBelowInCells,{execute:N("below-in-cells")}),o.addCommand(ee.explainCodeCell,{execute:I(t,e),label:"Explain cell with AI",icon:T}),o.addCommand(ee.codifyMdCell,{execute:I(t,e),label:"Codify cell with AI",icon:T}),o.addCommand(ee.explainOrCodifyCell,{execute:I(t,e),label:"Explain or codify cell with AI",icon:T})}}}}]);