{% extends 'usage/usage_base.html' %}
{% load static %}
{% load custom_tags_and_filters %}
{% load billing_tags %}
{% block extrahead %}
	<script type="text/javascript" src="{% static "datetimepicker/bootstrap-datetimepicker.js" %}"></script>
	<link rel="stylesheet" type="text/css" href="{% static "datetimepicker/bootstrap-datetimepicker.css" %}"/>
	<link rel="stylesheet" type="text/css" href="{% static "invoices/invoices.css" %}"/>
{% endblock %}
{% block usage_content %}
	<div style="margin-top:10px">
		<ul class="nav nav-pills" id="tabs">
			<li class="active"><a href="#usage" data-toggle="tab">Usage</a></li>
			{% if billing_service %}<li><a href="{{ tab_url }}" data-toggle="tab">Billing Information</a></li>{% endif %}
			{% if cap_discounts_url %}<li><a href="#cap_discount" onclick="$('#cap_discount').load('{{ cap_discounts_url }}')" data-toggle="tab">Cap information</a></li>{% endif %}
		</ul>
	</div>

	<div id="content" class="tab-content">
		<div class="tab-pane active" id="usage">
			<br/>
			<div class="pull-left">
				This data is provided for informational purposes and uses the <b>latest rates</b>.<br/>
				Other adjustments/discounts <b>might not be included</b> in this information.
			</div>
			{% if no_charges %}
				<div style="height: 15px;clear: both;"></div>
				<h3>There was no usage between {{ start_date|date }} and {{ end_date|date }}.</h3>
			{% else %}
				<div class="pull-right">Total charges: <b>{{ total_charges }}</b>{% if pending_charges %} (includes {{ pending_charges }} pending){% endif %}</div>
			{% endif %}
			<div style="height: 15px;clear: both;"></div>
			{% regroup detailed_items by item_type as detailed_items_by_type %}
			{% for detailed_item in detailed_items_by_type %}
				{% if detailed_item.grouper.name == "MISSED_RESERVATION" %}
					<h3>Missed reservations</h3>
					{% for m in detailed_item.list %}
						<div class="alert alert-danger table-display">
							<div class="table-cell-display col-sm-7">
								<span style="font-weight:bold">{{ m.item.reservation_item }}{{ m.rate_time_name_add }}</span><br>
								{% if project_autocomplete or selected_project %}Missed by {{ m.user }}<br>{% endif %}
								{{ m.start }}<br>
								Charged to project {{ m.project }}
							</div>
							<div class="table-cell-display text-center col-sm-3">{{ m.billable_rate|default_if_none:"" }}</div>
							<div class="table-cell-display text-right col-sm-2">{{ m.billable_display_amount }}</div>
						</div>
					{% endfor %}
				{% endif %}
				{% if detailed_item.grouper.name == "CONSUMABLE" %}
					<h3>Supplies and consumables</h3>
					{% for c in detailed_item.list %}
						<div class="alert alert-info table-display">
							<div class="table-cell-display col-sm-7">
								<span style="font-weight:bold">{{ c.consumable }}{{ c.rate_time_name_add }}</span><br>
								{% if project_autocomplete or selected_project %}<span style="font-weight:bold">For {{ c.item.customer }}</span><br>{% endif %}
								Quantity {{ c.quantity }}<br>
								Purchased from {{ c.item.merchant }}<br>
								{{ c.start }}<br>
								Charged to project {{ c.project }}
							</div>
							<div class="table-cell-display text-center col-sm-3">{{ c.billable_rate|default_if_none:"" }}</div>
							<div class="table-cell-display text-right col-sm-2">{{ c.billable_display_amount }}</div>
						</div>
					{% endfor %}
				{% endif %}
				{% if detailed_item.grouper.name == "STAFF_CHARGE" %}
					<h3>Staff charges</h3>
					{% for s in detailed_item.list %}
						{% if s.area %}
							<div class="alert alert-warning table-display">
								<div class="table-cell-display col-sm-7">
									<span style="font-weight:bold">{{ s.area }}{{ s.rate_time_name_add }}</span><br>
									<span style="font-weight:bold">Area accessed by {{ s.proxy_user }} {% if project_autocomplete or selected_project %}on behalf of {{ s.user }}{% else %}on your behalf{% endif %}</span><br>
									{{ s.start }}<br>
									{{ s.end|default_if_none:"In progress" }}<br>
									Charged to project {{ s.project }}
								</div>
								<div class="table-cell-display text-center col-sm-3">{{ s.billable_rate|default_if_none:"" }}</div>
								<div class="table-cell-display text-right col-sm-2">{{ s.billable_display_amount }}</div>
							</div>
						{% elif s.tool %}
							<div class="alert alert-warning table-display">
								<div class="table-cell-display col-sm-7">
									<span style="font-weight:bold">{{ s.tool }}{{ s.rate_time_name_add }}</span><br>
									<span style="font-weight:bold">Operated by {{ s.proxy_user }} {% if project_autocomplete or selected_project %}on behalf of {{ s.user }}{% else %}on your behalf{% endif %}</span><br>
									{{ s.start }}<br>
									{{ s.end }}<br>
									Charged to project {{ s.project }}
								</div>
								<div class="table-cell-display text-center col-sm-3">{{ s.billable_rate|default_if_none:"" }}</div>
								<div class="table-cell-display text-right col-sm-2">{{ s.billable_display_amount }}</div>
							</div>
						{% else %}
							<div class="alert alert-info table-display">
								<div class="table-cell-display col-sm-7">
									<span style="font-weight:bold">Work performed by {{ s.proxy_user }} {% if project_autocomplete or selected_project %}on behalf of {{ s.user }}{% else %}on your behalf{% endif %}{{ s.rate_time_name_add }}</span><br>
									{% if s.item.note %}Charge note: {{ s.item.note|linebreaksbr }}<br>{% endif %}
									{{ s.start }}<br>
									{{ s.end }}<br>
									Charged to project {{ s.project }}
								</div>
								<div class="table-cell-display text-center col-sm-3">{{ s.billable_rate|default_if_none:"" }}</div>
								<div class="table-cell-display text-right col-sm-2">{{ s.billable_display_amount }}</div>
							</div>
						{% endif %}
					{% endfor %}
				{% endif %}
				{% if detailed_item.grouper.name == "TRAINING" %}
					<h3>Training sessions</h3>
					{% for t in detailed_item.list %}
						<div class="alert alert-info table-display">
							<div class="table-cell-display col-sm-7">
								<span style="font-weight:bold">{{ t.tool }}{{ t.rate_time_name_add }}</span><br>
								{{ t.item.get_type_display }} training {% if project_autocomplete or selected_project %}for {{ t.user }} {% endif %}for {{ t.quantity }} minutes taught by <span style="font-weight:bold">{{ t.proxy_user }}</span>
								{{ t.start }}<br>
								Charged to project {{ t.project }}
							</div>
							<div class="table-cell-display text-center col-sm-3">{{ t.billable_rate|default_if_none:"" }}</div>
							<div class="table-cell-display text-right col-sm-2">{{ t.billable_display_amount }}</div>
						</div>
					{% endfor %}
				{% endif %}
				{% if detailed_item.grouper.name == "AREA_ACCESS" %}
					<h3>Area access</h3>
					{% for a in detailed_item.list %}
						<div class="alert {% if not a.item.staff_charge %}alert-info{% else %}alert-warning{% endif %} table-display">
							<div class="table-cell-display col-sm-7">
								<span style="font-weight:bold">{{ a.area }}{{ a.rate_time_name_add }}</span><br>
								{% if a.item.staff_charge %}<span style="font-weight:bold">Area accessed by {{ a.proxy_user }} {% if project_autocomplete or selected_project %}on behalf of {{ a.user }}{% else %}on your behalf{% endif %}</span><br>
								{% else %}{% if project_autocomplete or selected_project %}<span style="font-weight:bold">Area accessed by {{ a.user }}</span><br>{% endif %}
								{% endif %}
								{{ a.start }}<br>
								{{ a.end|default_if_none:"In progress" }}<br>
								Charged to project {{ a.project }}
							</div>
							<div class="table-cell-display text-center col-sm-3">{{ a.billable_rate|default_if_none:"" }}</div>
							<div class="table-cell-display text-right col-sm-2">{{ a.billable_display_amount }}</div>
						</div>
					{% endfor %}
				{% endif %}
				{% if detailed_item.grouper.name == "TOOL_USAGE" %}
					<h3>Tool usage</h3>
					{% for u in detailed_item.list %}
						<div class="alert {% if u.user == u.proxy_user %}alert-info{% else %}alert-warning{% endif %} table-display">
							<div class="table-cell-display col-sm-7">
								<span style="font-weight:bold">{{ u.tool }}{{ u.rate_time_name_add }}</span><br>
								{% if u.user != u.proxy_user %}<span style="font-weight:bold">Operated by {{ u.proxy_user }} {% if project_autocomplete or selected_project %}on behalf of {{ u.user }}{% else %}on your behalf{% endif %}</span><br>
								{% else %}{% if project_autocomplete or selected_project %}<span style="font-weight:bold">Operated by {{ u.user }}</span><br>{% endif %}
								{% endif %}
								{{ u.start }}<br>
								{{ u.end }}<br>
								Charged to project {{ u.project }}
							</div>
							<div class="table-cell-display text-center col-sm-3">{{ u.billable_rate|default_if_none:"" }}</div>
							<div class="table-cell-display text-right col-sm-2">{{ u.billable_display_amount }}</div>
						</div>
					{% endfor %}
				{% endif %}
				{% if detailed_item.grouper.name == "CUSTOM_CHARGE" %}
					<h3>Custom charges</h3>
					{% for c in detailed_item.list %}
						<div class="alert alert-info alert-table table-display">
							<div class="table-cell-display col-sm-7">
								<span style="font-weight:bold">{{ c.item.name }}<br>
								{% if project_autocomplete or selected_project %}For {{ c.user }}<br>{% endif %}</span>
								{{ c.start }}<br>
								Charged to project {{ c.project }}<br>
							</div>
							<div class="table-cell-display text-center col-sm-3">{{ c.billable_rate|default_if_none:"" }}</div>
							<div class="table-cell-display text-right col-sm-2">{{ c.billable_display_amount }}</div>
						</div>
					{% endfor %}
				{% endif %}
			{% endfor %}
		</div>
		<div class="tab-pane" id="cap_discount"></div>
	</div>
{% endblock %}