[tool.poetry]
name = "origen-ai-ecl"
version = "0.1.1"
description = ""
authors = ["Luis Arce <luis@origen.ai>"]
readme = "README.md"
packages = [{include = "origen/**/*"}]

[tool.poetry.dependencies]
python = "^3.8"

[tool.poetry.dev-dependencies]
poethepoet = "^0.16.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"


[tool.poe.tasks]
    _publish = 'poetry publish'

    [tool.poe.tasks.build]
        help='Build the python package for this project in dist folder'
        sequence=[
            {shell='rm -rf dist'},
            {shell='poetry build'}
        ]

    [tool.poe.tasks.publish]
        help='Build and upload the package to pypi'
        sequence = [
            'build',
            '_set_pypi_token',
            '_publish'
        ]

    [tool.poe.tasks._set_pypi_token]
        shell = 'poetry config pypi-token.pypi "${pypy_api_token}"'
        args = [
            {name = "pypy_api_token", help = "The pypy token to use to publish with poetry", default = "${PYPI_API_TOKEN}", positional=true}
        ]

    [tool.poe.tasks._unittest]
        shell='python -m unittest'

    [tool.poe.tasks.test]
        help="Run python tests"
        sequence = [
            'maybe_compile',
            '_unittest'
        ]

    [tool.poe.tasks.recompile]
        help="Build origen.ai.ecl package"
        shell='''
          rm -rf build origen &&
          mkdir build &&
          cd build &&
          cmake .. &&
          make &&
          cd .. &&
          mkdir -p origen/ai/ &&
          mv build/lib/ecl.*.so origen/ai/ &&
          touch origen/__init__.py &&
          touch origen/ai/__init__.py
        '''

    [tool.poe.tasks.maybe_compile]
        help="Compiles origen.ai.ecl if the package does not exist"
        control.expr = "str(len(__import__('glob').glob('origen/ai/ecl.*.so')))"
            [[tool.poe.tasks.maybe_compile.switch]]
                case='0'
                ref="recompile"
            [[tool.poe.tasks.maybe_compile.switch]]
                case='1'
                script="builtins:print('origen.ai.ecl found, skipping compilation')"
